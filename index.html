<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AnimateGame</title>

<script src="js/createjs-2015.05.21.combined.js"></script>
<script src="js/movieclip-0.8.1.min.js"></script>
<script src="js/Rnd.js"></script>
<script src="AnimateGame.js"></script>

	<link href='https://fonts.googleapis.com/css?family=Luckiest+Guy' rel='stylesheet' type='text/css'>

<script>
var c=createjs, canvas, stage, exportRoot;
var menu, game, obstacles, scoreFld, velY, hero;
var w, h, nextObstacle, baseSpeed=15, gravity, dead, inDash, score, difficulty;

function init() {
	canvas = document.getElementById("canvas");

	var loader = new c.LoadQueue(false);
	loader.installPlugin(createjs.Sound);
	loader.addEventListener("complete", handleComplete);
	loader.loadManifest(lib.properties.manifest);
}

function handleComplete(evt) {
	stage = new c.Stage("canvas");
	w = canvas.width;
	h = canvas.height;
	
	menu = new lib.Menu();
	menu.playBtn.on("click", startGame, this);
	
	stage.addChild(menu);
	
	c.Touch.enable(stage);
	stage.enableMouseOver();
	
	playSound("demosong");
	
	c.Ticker.setFPS(30);
	c.Ticker.on("tick", tick);
}

function tick(evt) {
	if (game) { gameTick(evt); }
	stage.update(evt);
}

function startGame() {
	menu.parent.removeChild(menu);
	game = new c.Container();
	velY = 0;
	score = 0;
	difficulty = 0;
	dead = false;
	gravity = 2;
	
	scoreFld = new c.Text("0", "72pt 'Luckiest Guy'");
	scoreFld.x = 20;
	scoreFld.y = 20;
	game.addChild(scoreFld);
	
	hero = new lib.Hero();
	hero.scaleX = hero.scaleY = 0.6;
	hero.x = 250;
	hero.y = 60;
	hero.gotoAndPlay("idle");
	game.addChild(hero);
	
	obstacles = new c.Container();
	game.addChild(obstacles);
	
	nextObstacle = 0;
	
	stage.on("stagemousedown", handleClick);
	
	window.addEventListener("keydown", handleKey);
	
	stage.addChild(game);
}

function endGame() {
	game.parent.removeChild(game);
	game = null;
	stage.addChild(menu);
}

function jump() {
	if (dead || inDash) { return; }
	velY = Math.max(-30, velY - 50);
	hero.gotoAndPlay("jump");
}

function dash() {
	if (dead || inDash) { return; }
	hero.gotoAndPlay("dash");
	c.Tween.get(hero, {override:true}).to({x:350}, 500);
	inDash = true;
}

function gameTick(evt) {
	difficulty = Math.sqrt(score)*0.1;
	var speed = baseSpeed*(difficulty+1);
	
	if (inDash) {
		if (changeWeight(-0.03) === 1) {
			hero.gotoAndPlay("idle");
			inDash = false;
			c.Tween.get(hero, {override:true}).to({x:250}, 500);
		} else {
			velY *= 0.9;
			speed *= 3.5;
		}
	}
	
	if (!inDash) { velY += gravity; }
	hero.y += velY;
	
	if (--nextObstacle < 0) {
		addObstacle();
	}
	
	for (var i=obstacles.numChildren-1; i>=0; i--) {
		var obstacle = obstacles.getChildAt(i);
		obstacle.x -= speed;
		if (obstacle.x < -100 && !dead) {
			obstacles.removeChild(obstacle);
			setScore(score+hero.body.body.scaleY);
		}
	}
	
	var target = obstacles.getObjectUnderPoint(hero.x, hero.y, 1);
	if (target && !dead) {
		if (target.trash) {
			target.parent.removeChild(target);
			changeWeight(0.2);
		} else if (!inDash) {
			dead = true;
			hero.gotoAndPlay("death");
			c.Tween.get().wait(3000).call(endGame);
		}
	}
}

function changeWeight(val) {
	var body = hero.body.body;
	body.scaleY = Math.max(1,body.scaleY+val);
	body.scaleX = 1+ (body.scaleY-1)*0.66;
	gravity = Math.pow(body.scaleY, 1.4)*3;
	return body.scaleY;
}

function setScore(val) {
	score = val;
	scoreFld.text = (score|0)*5000;
}

function addObstacle() {
	var obstacle = new c.Container();
	var top = new lib.Wall();
	var bottom = new lib.Wall();
	var gapSize = 400 - Math.sqrt(score*50);
	top.y = -308-gapSize/2;
	bottom.y = -top.y;
	obstacle.addChild(top, bottom);
	
	obstacle.y = h/2+Rnd(-200,200);
	obstacle.x = w+50;
	obstacles.addChild(obstacle);
	
	var scoreAdj = Math.min(25,Math.sqrt(score)*0.04);
	nextObstacle = Rnd.integer(50-scoreAdj,100-scoreAdj*2);
	
	var trash = new lib.Trash();
	trash.gotoAndStop(Rnd(trash.totalFrames)|0);
	trash.mouseChildren = false;
	trash.x = obstacle.x + nextObstacle*baseSpeed/2 + Rnd(10*baseSpeed, 20*baseSpeed);
	trash.y = Rnd(100, h-100);
	trash.trash = true;
	obstacles.addChild(trash);
}

function handleKey(evt) {
	if (evt.keyCode == 38) {
		jump();
	} else if (evt.keyCode == 39) {
		dash();
	}
}

function handleClick(evt) {
	if (evt.stageX < w/2) {
		jump();
	} else {
		dash();
	}
}

function playSound(id, loop) {
	createjs.Sound.play(id, createjs.Sound.INTERRUPT_EARLY, 0, 0, loop);
}
</script>
</head>

<body onload="init();" style="background-color:#D4D4D4;margin:0px;">
	<canvas id="canvas" width="1280" height="720" style="background-color:#FFFFFF"></canvas>
	<ul>
		<li>slow on death</li>
		<li>out of bounds</li>
		<li>difficulty: frequency, trash, gapSize, speed</li>
		<li>enemy / trash placement</li>
		<li>moving obstacles</li>
		<li>scoring / weight multiplier</li>
		<li>background</li>
		<li>menu art</li>
		<li>sound</li>
		<li>score reward or tween up?</li>
		<li>code comments</li>
		<li>optimize</li>
	</ul>
</body>
</html>